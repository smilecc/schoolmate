<extend name="Base/common"/>
<block name="navtab">
  <li class='active'><a href="#">数据导入</a></li>
</block>
<block name="body">
<script type="text/javascript">$('#sb-user').addClass('active')</script>
	<div class='panel panel-default'>
	  <div class='panel-heading'>
	    <i class='icon-table icon-large'></i>
	    Excel 数据导入
	    <div class='panel-tools'>

	    </div>
	  </div>
	  <div class='panel-body'>
	  	<if condition="$alert">
	  		<div class="alert alert-success" role="alert">导入成功！请勿重复操作！</div>
	  	</if>
	  	<form id="form-upload" action="{:U('/Admin/Excel/upload')}" method="post">
			<div class="form-group">
				<label for="exampleInputFile">Excel 文件上传 <a href="#">点击下载模板文件</a></label>
				<input type="file" id="file" name="file">
				<p class="help-block">请按模板填写，并且上传为xls格式（Office Excel 2003）的文件</p>
			</div>
			<hr/>
			<button class="btn btn-primary" type="submit">确认上传</button>
			<button class="btn btn-warring" type="button" onclick="$('#form-upload')[0].reset();">重置</button>
	  	</form>
	  </div>
	</div>
	<script type="text/javascript">
      $(function(){
        $('#form-upload').submit(function(e){
            if($(this)[0].checkValidity()) {
                    $(this).ajaxSubmit({
                        success:function(data){
                        	console.log(data);
                            var obj = JSON.parse(data);
                            
                            switch(obj['status'])
                            {
                            	case 0:
                            		window.location.href = '{:U('/Admin/User/index?alert=1')}';
                            		break;
                            	case 1: // Upload file error
                            		msg(obj['info']);
                            		$('#form-upload')[0].reset();
                            		break;
                            	case 2: // excel parse error
                            		var lineObj = obj['lines'];
                            		var alertText = obj['info'] + '，存在以下问题，<strong>请修复问题后重新上传</strong>：<br/>';
                            		for (var i = lineObj.length - 1; i >= 0; i--) {
                            			alertText += ('第' + lineObj[i].line + '行 找不到学年对应的班级 - <strong>'+ lineObj[i].year + lineObj[i].classname +'</strong><br/>')
                            		};
                            		msg(alertText);
                            		break;
                            }
                        }
                    });
                }else document.forms[0].reportValidity();
            return false;
        });
      });
	</script>
</block>